name: Deploy to Production

on:
  push:
    branches:
      - main
  workflow_dispatch:  # Allow manual trigger from GitHub UI

env:
  # Change this for each app repository
  APP_NAME: aspect-web-app
  APP_DIR: /var/www/apps/aspect-web-app

jobs:
  deploy:
    # Use self-hosted runner (for VPN/private servers)
    # Change to "ubuntu-latest" if using public server with SSH
    runs-on: [self-hosted, Linux]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Deploy application
        run: |
          echo "üì¶ Copying code to app directory..."
          rsync -av --delete --exclude='.git' --exclude='node_modules' \
            $GITHUB_WORKSPACE/ ${{ env.APP_DIR }}/
          
          echo "üì• Installing dependencies..."
          cd ${{ env.APP_DIR }}
          npm install --production
          
          echo "üîÑ Restarting service..."
          sudo /bin/systemctl restart ${{ env.APP_NAME }}
          
          echo "‚úÖ Deployment complete!"

      - name: Verify deployment
        run: |
          sleep 5
          sudo /bin/systemctl status ${{ env.APP_NAME }} --no-pager
          if sudo /bin/systemctl is-active --quiet ${{ env.APP_NAME }}; then
            echo "‚úÖ ${{ env.APP_NAME }} is running successfully"
          else
            echo "‚ùå ${{ env.APP_NAME }} failed to start"
            exit 1
          fi
